{% extends "base.html" %}

{% block content %}

<div class="container py-4">
  <!-- Welcome Header -->
  <div class="marketplace-header">
    <h1 class="display-6">AgriLink Marketplace</h1>
    <p class="lead">Welcome, <span class="fw-bold">{{ user }}</span>! Discover fresh crops from local farmers.</p>
  </div>

  <!-- Section 1: Available Crops -->
  <section class="mb-5">
    <h2 class="section-title">Available Crops for Sale</h2>

    <!-- Search and Filter Form -->
    <form method="GET" action="{{ url_for('buyer.dashboard') }}" class="mb-4 p-3 bg-light rounded border">
      <div class="row g-3 align-items-end">
        <div class="col-md-3">
          <label for="search_query" class="form-label">Search by Crop Name</label>
          <input type="text" name="search_query" id="search_query" class="form-control" placeholder="e.g., Maize, Tea" value="{{ search_query or '' }}">
        </div>
        <div class="col-md-3">
          <label for="crop_category" class="form-label">Filter by Crop Category</label>
          <select name="crop_category" id="crop_category" class="form-select">
            <option value="">All Categories</option>
            {% for category in crop_categories %}
            <option value="{{ category.crop_name }}" {% if crop_category == category.crop_name %}selected{% endif %}>{{ category.crop_name }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-3">
          <label for="location" class="form-label">Filter by Location</label>
          <select name="location" id="location" class="form-select">
            <option value="">All Locations</option>
            <option value="Balaka" {% if location == 'Balaka' %}selected{% endif %}>Balaka</option>
            <option value="Blantyre" {% if location == 'Blantyre' %}selected{% endif %}>Blantyre</option>
            <option value="Chikwawa" {% if location == 'Chikwawa' %}selected{% endif %}>Chikwawa</option>
            <option value="Chiradzulu" {% if location == 'Chiradzulu' %}selected{% endif %}>Chiradzulu</option>
            <option value="Chitipa" {% if location == 'Chitipa' %}selected{% endif %}>Chitipa</option>
            <option value="Dedza" {% if location == 'Dedza' %}selected{% endif %}>Dedza</option>
            <option value="Dowa" {% if location == 'Dowa' %}selected{% endif %}>Dowa</option>
            <option value="Karonga" {% if location == 'Karonga' %}selected{% endif %}>Karonga</option>
            <option value="Kasungu" {% if location == 'Kasungu' %}selected{% endif %}>Kasungu</option>
            <option value="Likoma" {% if location == 'Likoma' %}selected{% endif %}>Likoma</option>
            <option value="Lilongwe" {% if location == 'Lilongwe' %}selected{% endif %}>Lilongwe</option>
            <option value="Machinga" {% if location == 'Machinga' %}selected{% endif %}>Machinga</option>
            <option value="Mangochi" {% if location == 'Mangochi' %}selected{% endif %}>Mangochi</option>
            <option value="Mchinji" {% if location == 'Mchinji' %}selected{% endif %}>Mchinji</option>
            <option value="Mulanje" {% if location == 'Mulanje' %}selected{% endif %}>Mulanje</option>
            <option value="Mwanza" {% if location == 'Mwanza' %}selected{% endif %}>Mwanza</option>
            <option value="Mzimba" {% if location == 'Mzimba' %}selected{% endif %}>Mzimba</option>
            <option value="Neno" {% if location == 'Neno' %}selected{% endif %}>Neno</option>
            <option value="Nkhotakota" {% if location == 'Nkhotakota' %}selected{% endif %}>Nkhotakota</option>
            <option value="Nsanje" {% if location == 'Nsanje' %}selected{% endif %}>Nsanje</option>
            <option value="Ntcheu" {% if location == 'Ntcheu' %}selected{% endif %}>Ntcheu</option>
            <option value="Ntchisi" {% if location == 'Ntchisi' %}selected{% endif %}>Ntchisi</option>
            <option value="Phalombe" {% if location == 'Phalombe' %}selected{% endif %}>Phalombe</option>
            <option value="Rumphi" {% if location == 'Rumphi' %}selected{% endif %}>Rumphi</option>
            <option value="Salima" {% if location == 'Salima' %}selected{% endif %}>Salima</option>
            <option value="Thyolo" {% if location == 'Thyolo' %}selected{% endif %}>Thyolo</option>
            <option value="Zomba" {% if location == 'Zomba' %}selected{% endif %}>Zomba</option>
          </select>
        </div>
        <div class="col-md-3">
          <button type="submit" class="btn btn-success w-100">Search</button>
        </div>
      </div>
    </form>

    <div class="row g-4">
      {% if crops %}
        {% for crop in crops %}
        <div class="col-sm-12 col-md-6 col-lg-4">
          <!-- Reusing data_card style from data_view.html -->
          <div class="data-card">
            {% set crop_image_name = crop.crop_name | lower | replace(' ', '_') | replace('(', '') | replace(')', '') + '.jpg' %}
            {% if crop.image %}
                <img src="{{ url_for('static', filename='uploads/' + crop.image) }}" class="card-img-top" alt="{{ crop.crop_name }}">
            {% else %}
                <img src="{{ url_for('static', filename='crop_images/' + crop_image_name) }}" class="card-img-top" alt="{{ crop.crop_name }}" onerror="this.onerror=null;this.src='{{ url_for('static', filename='uploads/placeholder_crop.jpg') }}';">
            {% endif %}
            <div class="card-body">
              <h5 class="item-title">{{ crop.crop_name }}</h5>
              <p class="card-text">
                <strong>Price:</strong> MWK {{ "{:,.2f}".format(crop.price) }} / kg<br>
                <strong>Available:</strong> {{ crop.quantity }}<br>
                <strong>Grade:</strong> {{ crop.crop_grade }}<br>
                <strong>Location:</strong> {{ crop.location }}
              </p>
              <div class="d-flex align-items-center mb-3">
                <img src="{{ url_for('static', filename=(crop.profile_pic if crop.profile_pic else 'dp.png')) }}" class="profile-link img" alt="Farmer Profile">
                <small class="text-muted">Farmer: {{ crop.farmer_name }}</small>
              </div>
              <div class="d-flex gap-2 mt-2">
                <a href="{{ url_for('buyer.view_crop', crop_id=crop.id) }}" class="btn btn-success flex-fill">
                  <i class="fas fa-shopping-cart me-1"></i> Buy
                </a>
                <a href="{{ url_for('messaging.send_message', receiver_id=crop.farmer_id, crop_id=crop.id) }}" class="btn btn-outline-secondary" title="Contact Farmer">
                  <i class="fas fa-envelope"></i>
                </a>
              </div>
            </div>
          </div>
        </div>
        {% endfor %}
      {% else %}
        <div class="col-12">
          <div class="alert alert-info">No crops available at the moment. Check back later!</div>
        </div>
      {% endif %}
    </div>

    <!-- Pagination Controls -->
    {% if total_pages > 1 %}
    <nav aria-label="Page navigation" class="mt-4">
      <ul class="pagination justify-content-center">
        <!-- Previous Page Link -->
        <li class="page-item {% if page <= 1 %}disabled{% endif %}">
          <a class="page-link" href="{{ url_for('buyer.dashboard', page=page-1, search_query=search_query, location=location, crop_category=crop_category) }}">Previous</a>
        </li>

        <!-- Page Number Links -->
        {% for p in range(1, total_pages + 1) %}
        <li class="page-item {% if p == page %}active{% endif %}">
          <a class="page-link" href="{{ url_for('buyer.dashboard', page=p, search_query=search_query, location=location, crop_category=crop_category) }}">{{ p }}</a>
        </li>
        {% endfor %}

        <!-- Next Page Link -->
        <li class="page-item {% if page >= total_pages %}disabled{% endif %}">
          <a class="page-link" href="{{ url_for('buyer.dashboard', page=page+1, search_query=search_query, location=location, crop_category=crop_category) }}">Next</a>
        </li>
      </ul>
    </nav>
    {% endif %}
  </section>

  <!-- Section 2: My Posted Demands -->
  <section>
    <h2 class="section-title">ðŸ“¢ My Posted Demands</h2>
    {% with items=my_demands, list_type='demands', is_owner_view=True, title='' %}
      {% include 'data_view.html' %}
    {% endwith %}
  </section>
</div>

{% endblock %}
